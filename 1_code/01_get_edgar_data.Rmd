---
title: "Getting Data from SEC's EDGAR"
author: "Matthias Uckert"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_notebook
---

    # github_document:
    # toc: true
    # toc_depth: 2

# Description

xxx

```{r setup, include=FALSE, purl=FALSE}
knitr::opts_knit$set(root.dir = normalizePath(here::here())) 
knitr::opts_chunk$set(root.dir = normalizePath(here::here())) 
```

# Script Setup

```{r message=FALSE, warning=FALSE}
library(tidyverse); library(edgarWebR); library(lubridate); library(here)
library(furrr); library(stringi); library(textstem); library(tidytext)
library(janitor); library(tools); library(patchwork); library(scales)

.dir_main <- "2_output/01_get_edgar_data/"
if(!dir.exists(.dir_main)) dir.create(.dir_main, recursive = TRUE)

source("1_code/00_functions/f-all.R")
source("1_code/00_functions/f-get_edgar_data.R")
```

# Code

## Get Fortune 500 Companies

Her we use an open source data repository 'datahub.io' to retrieve the fortune 500 companies with some financial information. We won't use the complete data set, but filter for the top xxx companies with the highest market capitalization.

**Note:** Look at the function [**get_f500()**]{.ul}

```{r message=FALSE, warning=FALSE}
# browseURL("https://datahub.io/core/s-and-p-500-companies-financials#r")
tab_f500_all <- get_f500() %>%
  # Function from the janitor package, makes nice column names
  clean_names() %>%
  # Arrange, so that the highest market cap appears first in the dataframe
  arrange(desc(market_cap)) 

# Select only the firms with the highest market cap
tab_f500_t10 <- slice(tab_f500_all, 1:100)

```

## Get Company Index-Links

Retrieve EDGAR Index-Links for Fortune 500 company set.

```{r}
.path_filings <- "2_output/01_get_edgar_data/edgar_filings.rds"
if (!file.exists(.path_filings)) {
  .prc <- tibble(symbol = character(), .rows = 0)
} else {
  .prc <- read_rds(.path_filings)
}
tab_f500_use <- filter(tab_f500_t10, !symbol %in% .prc$symbol)

nrow(tab_f500_use)

if (nrow(tab_f500_use) > 0) {
  lst_filings <- map_company_filings(
    .tickers = tab_f500_use$symbol,
    .type = "10-K",
    .count = 100,
    .sleep = .2
  )
  .tab_filings <- bind_rows(.prc, bind_rows(lst_filings$result, .id = "symbol"))

  write_rds(.tab_filings, .path_filings)
} else {
  .tab_filings <- .prc
}
nrow(tab_f500_use)
rm(tab_f500_use)
```

```{r}
tab_filings <- .tab_filings %>%
  mutate(id = stri_replace_all_fixed(basename(href), paste0(".", file_ext(href)), "")) %>%
  distinct(id, .keep_all = TRUE)
```

## Get Company Details

XXX

```{r}
.path_details <- "2_output/01_get_edgar_data/edgar_details.rds"
if (!file.exists(.path_details)) {
  .prc <- tibble(id = character(), .rows = 0)
} else {
  .prc <- read_rds(.path_details)
}
tab_filings_use <- filter(tab_filings, !id %in% .prc$id)

if (nrow(tab_filings_use) > 0) {
  lst_details <- map_filing_details(tab_filings$id, tab_filings$href, .sleep = 1)
  lst_details <- transpose(lst_details$result)
  lst_details <- map(lst_details, ~ bind_rows(.x, .id = "id"))
  .tab_details <- reduce(lst_details, left_join, by = "id")
  
  .tab_details <- bind_rows(.prc, .tab_details)
  write_rds(.tab_details, .path_details)
} else {
  .tab_details <- .prc
}
```

```{r}
tab_filings_use <- filter(tab_filings, !id %in% .prc$id)
nrow(tab_filings_use)
rm(tab_filings_use)
```


## Select Documents for Download 
XXX

```{r}
tab_download <- .tab_details %>%
  distinct() %>%
  left_join(select(tab_filings, symbol, id), by = "id") %>%
  mutate(
    file_ext = tools::file_ext(href),
    year = year(period_date),
    size = size / 1e6,
    across(where(is.character), ~ stri_replace_all_regex(., "[[:blank:]]+", " ")),
    across(c(type.y, description.y), ~ if_else(. %in% c("", " "), NA_character_, .))
    ) %>%
  select(
    id, document, state = company_incorporation_state, sic = sic_code, year, symbol, 
    company_name, company_cik, ype1 = type.x, type2 = type.y, desc = description.y, 
    period_date, href, size, file_ext
  ) %>%
  filter(between(year, 2005, 2020))
```

```{r}
.tmp <- tab_download %>%
  group_by(year) %>%
  summarise(size = sum(size), n = n(), .groups = "drop")


.geom_size <- .tmp %>%
  ggplot(aes(x = year, y = size)) +
  geom_line(color = "blue") + 
  geom_point() + 
  
  theme_bw()

.geom_n <- .tmp %>%
  ggplot(aes(x = year, y = n)) +
  geom_col(fill = "blue") + 
  theme_bw()

.geom_rel <- .tmp %>%
  ggplot(aes(x = year, y = size / n)) +
  geom_line(color = "blue") + 
  geom_point() + 
  theme_bw()

.geom_size / .geom_n / .geom_rel
  
```


```{r}
tab_download_txt <- tab_download %>%
  filter(file_ext == "txt", desc == "Complete submission text file") %>%
  arrange(symbol, desc(year), desc(period_date)) %>%
  distinct(symbol, year, .keep_all = TRUE) %>%
  distinct(document, .keep_all = TRUE)

cat(paste0(
  "Docs: ", comma(nrow(tab_download_txt)), "\n",
  "Size: ", comma(sum(tab_download_txt$size)), " MB")
  )
```

```{r}
tab_download_htm <- tab_download %>%
  filter(startsWith(file_ext, "htm"), grepl("10-K", desc)) %>%
  arrange(symbol, desc(year), desc(period_date)) %>%
  distinct(symbol, year, .keep_all = TRUE) %>%
  distinct(document, .keep_all = TRUE)

cat(paste0(
  "Docs: ", comma(nrow(tab_download_htm)), "\n",
  "Size: ", comma(sum(tab_download_htm$size)), " MB")
  )
```

```{r}
tab_download_xxx <- tab_download %>%
  filter(startsWith(file_ext, "x")) %>%
  arrange(symbol, desc(year), desc(period_date)) %>%
  distinct(document, .keep_all = TRUE)

cat(paste0(
  "Docs: ", comma(nrow(tab_download_xxx)), "\n",
  "Size: ", comma(sum(tab_download_xxx$size)), " MB")
  )
```

## Download Documents
```{r}
.dir_docs <- "2_output/01_get_edgar_data/documents/"
tab_xxx <- download_edgar_files(tab_download_xxx, .dir_docs, 10, 2)
tab_htm <- download_edgar_files(tab_download_htm, .dir_docs, 10, 2)
tab_txt <- download_edgar_files(tab_download_txt, .dir_docs, 10, 2)

tab_zip_files <- list_files_tab(.dir_docs, info = TRUE) %>%
  select(doc_id, file_ext, path, size) %>%
  mutate(size = size / 1e6)

cat(paste0(
  "Docs: ", comma(nrow(tab_zip_files)), "\n",
  "Size: ", comma(sum(tab_zip_files$size)), " MB")
  )
```


## Save Files
```{r}
write_rds(tab_download_htm, "2_output/01_get_edgar_data/htm_download.rds")
write_rds(tab_download_txt, "2_output/01_get_edgar_data/txt_download.rds")
write_rds(tab_download_xxx, "2_output/01_get_edgar_data/xxx_download.rds")
```





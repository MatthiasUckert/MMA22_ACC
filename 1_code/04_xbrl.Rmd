---
title: "Textual Analysis"
author: "Matthias Uckert"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

    # github_document:
    # toc: true
    # toc_depth: 2

# Description

xxx

```{r setup, include=FALSE, purl=FALSE}
knitr::opts_knit$set(root.dir = normalizePath(here::here())) 
knitr::opts_chunk$set(root.dir = normalizePath(here::here())) 
```

# Script Setup

```{r message=FALSE, warning=FALSE}
library(tidyverse); library(zip); library(furrr); library(stringi)

.dir_main <- "2_output/04_xbrl"
if(!dir.exists(.dir_main)) dir.create(.dir_main, recursive = TRUE)

source("1_code/00_functions/f-all.R")
source("1_code/00_functions/f-xbrl.R")
```

# Code

## Paths
```{r}
lst_paths <- list(
  dir_main = "2_output/04_xbrl",
  dir_sec = "2_output/01_get_edgar_data/documents/",
  path_sec_data = "2_output/01_get_edgar_data/txt_download.rds",
  dir_tmp = "2_output/04_xbrl/tmp",
  dir_elements_raw = "2_output/04_xbrl/elements_raw",
  dir_elements_prc = "2_output/04_xbrl/elements_prc"
) %>% create_dirs()
```

## List Files
```{r}
tab_files_sec <- list_files_tab(lst_paths$dir_sec, reg = "zip$") %>%
  filter(startsWith(doc_id, "xxx"))
```


```{r}
.prc <- list_files_tab(lst_paths$dir_elements_raw)
tab_files_sec_use <- filter(tab_files_sec, !doc_id %in% .prc$doc_id)

plan("multisession", workers = 8)
future_walk(
  .x = tab_files_sec_use$path, 
  .f = ~ xbrl_extract_elements(.x, lst_paths$dir_tmp, lst_paths$dir_elements_raw),
  .options = furrr_options(seed = TRUE),
  .progress = TRUE
  )
plan("default")

```


```{r}
tab_files_elements_raw <- list_files_tab(lst_paths$dir_elements_raw)
.prc <- list_files_tab(lst_paths$dir_elements_prc)
tab_files_elements_use <- filter(tab_files_elements_raw, !doc_id %in% .prc$doc_id)

plan("multisession", workers = 8)
future_walk(
  .x = tab_files_elements_use$path,
  .f = ~ {
    read_rds(.x) %>%
      xbrl_process_elements() %>%
      enframe() %>%
      separate(name, c("type", "name"), sep = "_") %>%
      write_rds(file.path(lst_paths$dir_elements_prc, basename(.x)), compress = "gz")
  },
  .options = furrr_options(seed = TRUE),
  .progress = TRUE
)
plan("default")

```



```{r}
tab_files_elements_prc <- list_files_tab(lst_paths$dir_elements_prc) %>%
  separate(doc_id, c("tmp", "symbol", "year"), sep = "_|-", convert = TRUE, remove = FALSE)
```


```{r}
plan("multisession", workers = 4)
tab_elements0 <- future_map_dfr(
  .x = set_names(tab_files_elements_prc$path, tab_files_elements_prc$doc_id),
  .f = ~ mutate(read_rds(.x), value = as.list(value)),
  .options = furrr_options(seed = TRUE),
  .progress = TRUE,
  .id = "doc_id"
) %>%
  separate(doc_id, c("tmp", "symbol", "year"), sep = "_|-", convert = TRUE, remove = FALSE) %>%
  select(-tmp)
plan("default")

tab_lu <- openxlsx::read.xlsx("0_data/xbrl_lookup_table.xlsx")
tab_elements1 <- tab_elements0 %>%
  mutate(
    name_adj = name %>%
      stri_replace_all_regex(., "[[:punct:]]", " ") %>%
      stri_replace_all_regex(., "([[:blank:]]|[[:space:]])+", " ") %>%
      trimws() %>%
      tolower()
    ) %>%
  left_join(tab_lu, by = c("type", "name_adj")) %>%
  filter(desc == "Significant Accounting Policies")

write.table(tab_elements1, "clipboard", sep="\t", row.names = FALSE)
```
